<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orimori - –ü—Ä–æ—Ñ–∏–ª—å</title>
  <meta name="description" content="Orimori –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã –ø—Ä–æ—Ñ–∏–ª—ñ" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(180deg, hsl(35, 30%, 97%), hsl(35, 30%, 92%));
      min-height: 100vh;
      color: hsl(25, 15%, 20%);
      position: relative;
      overflow-x: hidden;
      padding-bottom: 80px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background: linear-gradient(180deg, hsl(220, 30%, 15%), hsl(220, 30%, 10%));
      color: hsl(0, 0%, 95%);
    }

    .rice-pattern {
      position: fixed;
      inset: 0;
      opacity: 0.03;
      background-image: 
        radial-gradient(circle at 20% 30%, hsl(25, 15%, 20%) 1px, transparent 1px),
        radial-gradient(circle at 60% 70%, hsl(25, 15%, 20%) 1px, transparent 1px),
        radial-gradient(circle at 80% 20%, hsl(25, 15%, 20%) 1px, transparent 1px);
      background-size: 40px 40px, 60px 60px, 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    body.dark .rice-pattern {
      opacity: 0.05;
      background-image: 
        radial-gradient(circle at 20% 30%, hsl(0, 0%, 95%) 1px, transparent 1px),
        radial-gradient(circle at 60% 70%, hsl(0, 0%, 95%) 1px, transparent 1px),
        radial-gradient(circle at 80% 20%, hsl(0, 0%, 95%) 1px, transparent 1px);
    }

    .container {
      position: relative;
      z-index: 10;
      max-width: 42rem;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding: 1rem;
      animation: fadeInUp 0.7s ease-out;
    }

    .header-title {
      flex: 1;
      text-align: center;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .header .subtitle {
      font-size: 0.9rem;
      color: hsl(25, 10%, 45%);
    }

    body.dark .header .subtitle {
      color: hsl(0, 0%, 65%);
    }

    .settings-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 12px -2px rgba(60, 45, 40, 0.08);
    }

    body.dark .settings-btn {
      background: hsl(220, 30%, 20%);
    }

    .settings-btn:hover {
      transform: rotate(90deg);
      box-shadow: 0 4px 20px -2px rgba(60, 45, 40, 0.12);
    }

    .settings-btn.hidden {
      visibility: hidden;
    }

    .profile-hero {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem 1.5rem;
      box-shadow: 0 4px 20px -4px rgba(60, 45, 40, 0.08);
      text-align: center;
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.7s ease-out 0.1s backwards;
    }

    body.dark .profile-hero {
      background: hsl(220, 30%, 18%);
      box-shadow: 0 4px 20px -4px rgba(0, 0, 0, 0.3);
    }

    .profile-photo-container {
      position: relative;
      width: 180px;
      height: 180px;
      margin: 0 auto 1.5rem;
    }

    .progress-ring {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s ease;
      fill: none;
      stroke-width: 8;
    }

    .progress-ring-background {
      stroke: hsl(25, 10%, 85%);
    }

    body.dark .progress-ring-background {
      stroke: hsl(220, 30%, 25%);
    }

    .progress-ring-progress {
      stroke: hsl(350, 75%, 58%);
    }

    .profile-photo {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 156px;
      height: 156px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
    }

    body.dark .profile-photo {
      border-color: hsl(220, 30%, 18%);
    }

    .profile-name {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .profile-bio {
      font-size: 1rem;
      color: hsl(25, 10%, 45%);
      margin-bottom: 1rem;
    }

    body.dark .profile-bio {
      color: hsl(0, 0%, 65%);
    }

    .profile-rank {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, hsl(350, 75%, 58%), hsl(350, 75%, 48%));
      color: white;
      border-radius: 2rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-rank:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(232, 53, 78, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.7s ease-out 0.2s backwards;
    }

    .stat-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 2px 12px -2px rgba(60, 45, 40, 0.08);
      text-align: center;
      transition: all 0.3s ease;
    }

    body.dark .stat-card {
      background: hsl(220, 30%, 18%);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px -2px rgba(60, 45, 40, 0.12);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: hsl(350, 75%, 58%);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: hsl(25, 10%, 45%);
    }

    body.dark .stat-label {
      color: hsl(0, 0%, 65%);
    }

    .achievements-section {
      background: white;
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 4px 20px -4px rgba(60, 45, 40, 0.08);
      animation: fadeInUp 0.7s ease-out 0.3s backwards;
    }

    body.dark .achievements-section {
      background: hsl(220, 30%, 18%);
    }

    .achievements-section h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 1rem;
    }

    .achievement-item {
      text-align: center;
      padding: 1rem;
      background: hsl(35, 30%, 95%);
      border-radius: 1rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    body.dark .achievement-item {
      background: hsl(220, 30%, 22%);
    }

    .achievement-item:hover {
      transform: scale(1.05);
      background: hsl(350, 75%, 95%);
    }

    body.dark .achievement-item:hover {
      background: hsl(220, 30%, 25%);
    }

    .achievement-item.locked {
      opacity: 0.4;
      filter: grayscale(100%);
    }

    .achievement-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .achievement-name {
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Popup styles */
    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .popup-overlay.active {
      display: flex;
    }

    .popup {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: popupSlideUp 0.3s ease;
      position: relative;
    }

    body.dark .popup {
      background: hsl(220, 30%, 18%);
    }

    .popup-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: hsl(25, 10%, 85%);
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    body.dark .popup-close {
      background: hsl(220, 30%, 25%);
    }

    .popup-close:hover {
      background: hsl(350, 75%, 58%);
      color: white;
      transform: rotate(90deg);
    }

    .popup h2 {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    /* Rank table */
    .rank-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .rank-table th,
    .rank-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid hsl(25, 10%, 85%);
    }

    body.dark .rank-table th,
    body.dark .rank-table td {
      border-bottom-color: hsl(220, 30%, 25%);
    }

    .rank-table th {
      font-weight: 600;
      background: hsl(35, 30%, 95%);
    }

    body.dark .rank-table th {
      background: hsl(220, 30%, 22%);
    }

    .rank-table tr:hover {
      background: hsl(35, 30%, 97%);
    }

    body.dark .rank-table tr:hover {
      background: hsl(220, 30%, 20%);
    }

    .rank-table .mythic {
      color: hsl(280, 75%, 58%);
      font-weight: bold;
    }

    /* Settings popup */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid hsl(25, 10%, 85%);
      border-radius: 0.75rem;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: white;
      color: hsl(25, 15%, 20%);
    }

    body.dark .form-group input,
    body.dark .form-group textarea {
      background: hsl(220, 30%, 15%);
      border-color: hsl(220, 30%, 25%);
      color: hsl(0, 0%, 95%);
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: hsl(350, 75%, 58%);
      box-shadow: 0 0 0 3px rgba(232, 53, 78, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .photo-upload-area {
      border: 2px dashed hsl(25, 10%, 85%);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: hsl(35, 30%, 97%);
      color: hsl(25, 10%, 45%);
    }

    body.dark .photo-upload-area {
      background: hsl(220, 30%, 15%);
      border-color: hsl(220, 30%, 25%);
      color: hsl(0, 0%, 65%);
    }

    .photo-upload-area:hover {
      border-color: hsl(350, 75%, 58%);
      background: hsl(35, 30%, 95%);
    }

    body.dark .photo-upload-area:hover {
      background: hsl(220, 30%, 20%);
    }

    .photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 0.5rem;
      display: none;
    }

    .photo-preview.visible {
      display: block;
    }

    .language-selector {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 1rem 0;
    }

    .language-flag {
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.5;
      filter: grayscale(100%);
    }

    .language-flag.active {
      opacity: 1;
      filter: grayscale(0%);
      transform: scale(1.2);
    }

    .language-flag:hover {
      transform: scale(1.1);
    }

    .theme-toggle {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .theme-option {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      border: 2px solid hsl(25, 10%, 85%);
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    body.dark .theme-option {
      background: hsl(220, 30%, 15%);
      border-color: hsl(220, 30%, 25%);
    }

    .theme-option.active {
      background: linear-gradient(135deg, hsl(350, 75%, 58%), hsl(350, 75%, 48%));
      color: white;
      border-color: hsl(350, 75%, 58%);
    }

    .theme-option:hover {
      transform: translateY(-2px);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.85rem 1.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      font-family: inherit;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, hsl(350, 75%, 58%), hsl(350, 75%, 48%));
      color: white;
      box-shadow: 0 4px 12px rgba(232, 53, 78, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 16px rgba(232, 53, 78, 0.4);
      transform: translateY(-2px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes popupSlideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="rice-pattern"></div>

  <div class="container">
    <div class="header">
      <div style="width: 40px;"></div>
      <div class="header-title">
        <h1>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h1>
        <p class="subtitle">–ö”©—Ä—ñ“£—ñ–∑ –ø—Ä–æ—Ñ–∏–ª—ñ“£—ñ–∑–¥—ñ</p>
      </div>
      <button class="settings-btn hidden" id="settingsBtn" title="–ë–∞–ø—Ç–∞—É–ª–∞—Ä">‚öôÔ∏è</button>
    </div>

    <div class="profile-hero">
      <div class="profile-photo-container">
        <svg class="progress-ring" width="180" height="180">
          <circle class="progress-ring-circle progress-ring-background" 
                  stroke-width="8" fill="transparent" r="82" cx="90" cy="90"/>
          <circle class="progress-ring-circle progress-ring-progress" 
                  stroke-width="8" fill="transparent" r="82" cx="90" cy="90"
                  id="progressCircle"/>
        </svg>
        <img src="https://ui-avatars.com/api/?name=User&size=156&background=e8354e&color=fff" 
             alt="Profile" class="profile-photo" id="profilePhoto">
      </div>
      
      <h2 class="profile-name" id="profileName">–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã</h2>
      <p class="profile-bio" id="profileBio">–ü—Ä–æ—Ñ–∏–ª—å —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã</p>
      
      <div class="profile-rank" id="profileRank" title="–î–µ“£–≥–µ–π–¥—ñ –∫”©—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑">
        <span id="rankIcon">üåü</span>
        <span id="rankText">Level 1 - –ù–æ–≤–∏—á–æ–∫</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statXP">0</div>
        <div class="stat-label">XP</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statOrders">0</div>
        <div class="stat-label">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statFavorites">0</div>
        <div class="stat-label">–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statVisits">0</div>
        <div class="stat-label">–ö—ñ—Ä—É–ª–µ—Ä</div>
      </div>
    </div>

    <div class="achievements-section">
      <h2>üèÜ –ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä</h2>
      <div class="achievements-grid" id="achievementsGrid">
        <div class="achievement-item">
          <div class="achievement-icon">üçô</div>
          <div class="achievement-name">–ë—ñ—Ä—ñ–Ω—à—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å</div>
        </div>
        <div class="achievement-item locked">
          <div class="achievement-icon">üî•</div>
          <div class="achievement-name">5 —Ç–∞–ø—Å—ã—Ä—ã—Å</div>
        </div>
        <div class="achievement-item locked">
          <div class="achievement-icon">‚≠ê</div>
          <div class="achievement-name">10 —Ç–∞–ø—Å—ã—Ä—ã—Å</div>
        </div>
        <div class="achievement-item locked">
          <div class="achievement-icon">üíé</div>
          <div class="achievement-name">–ê—É—Ä—É–ª—ã –∂–∞–Ω</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rank Popup -->
  <div class="popup-overlay" id="rankPopup">
    <div class="popup">
      <button class="popup-close" id="rankPopupClose">‚úï</button>
      <h2>üèÜ –¢–∞–±–ª–∏—Ü–∞ –∑–≤–∞–Ω–∏–π</h2>
      <table class="rank-table">
        <thead>
          <tr>
            <th>XP</th>
            <th>Level</th>
            <th>Rank</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>0</td>
            <td>1</td>
            <td>–ù–æ–≤–∏—á–æ–∫</td>
          </tr>
          <tr>
            <td>50</td>
            <td>2</td>
            <td>–£—á–µ–Ω–∏–∫ –†–∏—Å–∞</td>
          </tr>
          <tr>
            <td>200</td>
            <td>3</td>
            <td>–†–æ–ª–ª-–í–æ–∏–Ω</td>
          </tr>
          <tr>
            <td>500</td>
            <td>4</td>
            <td>–ú–∞—Å—Ç–µ—Ä –í–∫—É—Å–æ–≤</td>
          </tr>
          <tr>
            <td>1000</td>
            <td>5</td>
            <td>–•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–æ—É—Å–∞</td>
          </tr>
          <tr>
            <td>2000</td>
            <td>6</td>
            <td>–ó–∞—â–∏—Ç–Ω–∏–∫ –¢—Ä–µ–∑—É–±—Ü–∞</td>
          </tr>
          <tr>
            <td>top-10</td>
            <td>7</td>
            <td class="mythic">–ë–æ–≥ –í–∫—É—Å–æ–≤ (–º–∏—Ñ–∏—á–µ—Å–∫–∏–π —Ä–∞–Ω–≥)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Settings Popup -->
  <div class="popup-overlay" id="settingsPopup">
    <div class="popup">
      <button class="popup-close" id="settingsPopupClose">‚úï</button>
      <h2>‚öôÔ∏è –ë–∞–ø—Ç–∞—É–ª–∞—Ä</h2>
      
      <div class="form-group">
        <label>üì∏ –ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ—Ç–æ—Å—ã</label>
        <div class="photo-upload-area" id="photoUploadArea">
          <img src="" alt="Preview" class="photo-preview" id="photoPreview">
          <input type="file" accept="image/*" style="display: none;" id="photoInput">
          <div id="uploadText">
            üì∑ –§–æ—Ç–æ–Ω—ã –∂“Ø–∫—Ç–µ—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>‚úèÔ∏è –ê—Ç—ã-–∂”©–Ω—ñ</label>
        <input type="text" id="nameInput" placeholder="–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑">
      </div>

      <div class="form-group">
        <label>üìù ”®–∑—ñ“£—ñ–∑ —Ç—É—Ä–∞–ª—ã</label>
        <textarea id="bioInput" placeholder="”®–∑—ñ“£—ñ–∑ —Ç—É—Ä–∞–ª—ã –∂–∞–∑—ã“£—ã–∑..."></textarea>
      </div>

      <div class="form-group">
        <label>üåê –¢—ñ–ª / Language</label>
        <div class="language-selector">
          <span class="language-flag" data-lang="kk">üá∞üáø</span>
          <span class="language-flag active" data-lang="ru">üá∑üá∫</span>
          <span class="language-flag" data-lang="en">üá∫üá∏</span>
        </div>
      </div>

      <div class="form-group">
        <label>üåó –¢–∞“õ—ã—Ä—ã–ø / Theme</label>
        <div class="theme-toggle">
          <div class="theme-option active" data-theme="light">‚òÄÔ∏è –ñ–∞—Ä—ã“õ</div>
          <div class="theme-option" data-theme="dark">üåô “ö–∞—Ä–∞“£“ì—ã</div>
        </div>
      </div>

      <button class="btn btn-primary" id="saveSettingsBtn">
        üíæ –°–∞“õ—Ç–∞—É
      </button>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Translations
    const translations = {
      kk: {
        title: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',
        subtitle: '–ö”©—Ä—ñ“£—ñ–∑ –ø—Ä–æ—Ñ–∏–ª—ñ“£—ñ–∑–¥—ñ',
        xp: 'XP',
        orders: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä',
        favorites: '–¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä',
        visits: '–ö—ñ—Ä—É–ª–µ—Ä',
        achievements: 'üèÜ –ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä',
        settings: '‚öôÔ∏è –ë–∞–ø—Ç–∞—É–ª–∞—Ä',
        save: 'üíæ –°–∞“õ—Ç–∞—É'
      },
      ru: {
        title: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',
        subtitle: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å',
        xp: 'XP',
        orders: '–ó–∞–∫–∞–∑—ã',
        favorites: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
        visits: '–ü–æ—Å–µ—â–µ–Ω–∏—è',
        achievements: 'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
        settings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        save: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
      },
      en: {
        title: 'üë§ Profile',
        subtitle: 'View your profile',
        xp: 'XP',
        orders: 'Orders',
        favorites: 'Favorites',
        visits: 'Visits',
        achievements: 'üèÜ Achievements',
        settings: '‚öôÔ∏è Settings',
        save: 'üíæ Save'
      }
    };

    // Rank levels
    const rankLevels = [
      { xp: 0, level: 1, name: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü' },
      { xp: 50, level: 2, name: '–£—á–µ–Ω–∏–∫ –†–∏—Å–∞', icon: 'üçô' },
      { xp: 200, level: 3, name: '–†–æ–ª–ª-–í–æ–∏–Ω', icon: '‚öîÔ∏è' },
      { xp: 500, level: 4, name: '–ú–∞—Å—Ç–µ—Ä –í–∫—É—Å–æ–≤', icon: 'üë®‚Äçüç≥' },
      { xp: 1000, level: 5, name: '–•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–æ—É—Å–∞', icon: 'üè∫' },
      { xp: 2000, level: 6, name: '–ó–∞—â–∏—Ç–Ω–∏–∫ –¢—Ä–µ–∑—É–±—Ü–∞', icon: 'üî±' },
      { xp: Infinity, level: 7, name: '–ë–æ–≥ –í–∫—É—Å–æ–≤', icon: 'üëë' } // top-10
    ];

    function getRankFromXP(xp) {
      for (let i = rankLevels.length - 1; i >= 0; i--) {
        if (xp >= rankLevels[i].xp) {
          return rankLevels[i];
        }
      }
      return rankLevels[0];
    }

    function getNextRank(currentXP) {
      for (let i = 0; i < rankLevels.length - 1; i++) {
        if (currentXP < rankLevels[i + 1].xp) {
          return rankLevels[i + 1];
        }
      }
      return rankLevels[rankLevels.length - 1];
    }

    function updateProgressRing(current, total) {
      const circle = document.getElementById('progressCircle');
      const radius = 82;
      const circumference = radius * 2 * Math.PI;
      const percent = Math.min((current / total) * 100, 100);
      const offset = circumference - (percent / 100) * circumference;
      
      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      circle.style.strokeDashoffset = offset;
    }

    // Check if viewing another user's profile
    const urlParams = new URLSearchParams(window.location.search);
    const viewingUserId = urlParams.get('id');
    const isOwnProfile = !viewingUserId;

    // Show settings button only on own profile
    if (isOwnProfile) {
      document.getElementById('settingsBtn').classList.remove('hidden');
    }

    // Load profile data
    async function loadProfile() {
      let userId;
      
      if (viewingUserId) {
        // Viewing another user's profile
        userId = viewingUserId;
      } else {
        // Own profile - get from Telegram
        try {
          userId = Telegram.WebApp.initDataUnsafe.user.id;
        } catch (e) {
          console.error('Failed to get Telegram user ID:', e);
          userId = 'demo_user'; // Fallback for testing
        }
      }

      // Fetch user data from Supabase
      try {
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .eq('telegram_id', userId)
          .single();

        if (error) throw error;

        if (data) {
          // Update profile display
          document.getElementById('profileName').textContent = data.display_name || '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã';
          document.getElementById('profileBio').textContent = data.bio || '–ü—Ä–æ—Ñ–∏–ª—å —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã';
          
          if (data.photo_url) {
            document.getElementById('profilePhoto').src = data.photo_url;
          }

          // Update stats
          document.getElementById('statXP').textContent = data.xp || 0;
          document.getElementById('statOrders').textContent = data.orders_count || 0;
          document.getElementById('statFavorites').textContent = data.favorites_count || 0;
          document.getElementById('statVisits').textContent = data.visits_count || 0;

          // Update rank
          const rank = getRankFromXP(data.xp || 0);
          const nextRank = getNextRank(data.xp || 0);
          
          document.getElementById('rankIcon').textContent = rank.icon;
          document.getElementById('rankText').textContent = `Level ${rank.level} - ${rank.name}`;

          // Update progress ring
          const currentXP = data.xp || 0;
          const nextLevelXP = nextRank.xp === Infinity ? currentXP : nextRank.xp;
          updateProgressRing(currentXP, nextLevelXP);

          // If own profile, populate form
          if (isOwnProfile) {
            document.getElementById('nameInput').value = data.display_name || '';
            document.getElementById('bioInput').value = data.bio || '';
            if (data.photo_url) {
              const preview = document.getElementById('photoPreview');
              preview.src = data.photo_url;
              preview.classList.add('visible');
            }
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    // Popup handlers
    document.getElementById('profileRank').addEventListener('click', () => {
      document.getElementById('rankPopup').classList.add('active');
    });

    document.getElementById('rankPopupClose').addEventListener('click', () => {
      document.getElementById('rankPopup').classList.remove('active');
    });

    document.getElementById('rankPopup').addEventListener('click', (e) => {
      if (e.target.id === 'rankPopup') {
        document.getElementById('rankPopup').classList.remove('active');
      }
    });

    // Settings popup
    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsPopup').classList.add('active');
    });

    document.getElementById('settingsPopupClose').addEventListener('click', () => {
      document.getElementById('settingsPopup').classList.remove('active');
    });

    document.getElementById('settingsPopup').addEventListener('click', (e) => {
      if (e.target.id === 'settingsPopup') {
        document.getElementById('settingsPopup').classList.remove('active');
      }
    });

    // Photo upload
    document.getElementById('photoUploadArea').addEventListener('click', () => {
      document.getElementById('photoInput').click();
    });

    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById('photoPreview');
          preview.src = e.target.result;
          preview.classList.add('visible');
        };
        reader.readAsDataURL(file);
      }
    });

    // Language selector
    document.querySelectorAll('.language-flag').forEach(flag => {
      flag.addEventListener('click', () => {
        document.querySelectorAll('.language-flag').forEach(f => f.classList.remove('active'));
        flag.classList.add('active');
        const lang = flag.dataset.lang;
        localStorage.setItem('language', lang);
        // Apply translations here if needed
      });
    });

    // Theme toggle
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
        option.classList.add('active');
        const theme = option.dataset.theme;
        
        if (theme === 'dark') {
          document.body.classList.add('dark');
        } else {
          document.body.classList.remove('dark');
        }
        
        localStorage.setItem('theme', theme);
      });
    });

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      const name = document.getElementById('nameInput').value;
      const bio = document.getElementById('bioInput').value;
      const photoFile = document.getElementById('photoInput').files[0];

      try {
        let userId;
        try {
          userId = Telegram.WebApp.initDataUnsafe.user.id;
        } catch (e) {
          userId = 'demo_user';
        }

        let photoUrl = null;
        
        // Upload photo if selected
        if (photoFile) {
          const fileExt = photoFile.name.split('.').pop();
          const fileName = `${userId}-${Date.now()}.${fileExt}`;
          
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('profile-photos')
            .upload(fileName, photoFile);

          if (uploadError) throw uploadError;

          const { data: urlData } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(fileName);
          
          photoUrl = urlData.publicUrl;
        }

        // Update user data
        const updateData = {
          display_name: name,
          bio: bio
        };

        if (photoUrl) {
          updateData.photo_url = photoUrl;
        }

        const { error } = await supabase
          .from('users')
          .update(updateData)
          .eq('telegram_id', userId);

        if (error) throw error;

        // Close popup and reload
        document.getElementById('settingsPopup').classList.remove('active');
        await loadProfile();
        
        alert('–ë–∞–ø—Ç–∞—É–ª–∞—Ä —Å–∞“õ—Ç–∞–ª–¥—ã!');
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã!');
      }
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark');
      document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
      document.querySelector('[data-theme="dark"]').classList.add('active');
    }

    // Load saved language
    const savedLang = localStorage.getItem('language');
    if (savedLang) {
      document.querySelectorAll('.language-flag').forEach(f => f.classList.remove('active'));
      document.querySelector(`[data-lang="${savedLang}"]`)?.classList.add('active');
    }

    // Initialize
    loadProfile();
  </script>
</body>
</html>