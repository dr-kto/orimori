<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orimori - –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</title>
  <meta name="description" content="Orimori —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(180deg, hsl(35, 30%, 97%), hsl(35, 30%, 92%));
      min-height: 100vh;
      color: hsl(25, 15%, 20%);
      position: relative;
      overflow-x: hidden;
      padding-bottom: 120px;
    }

    .rice-pattern {
      position: fixed;
      inset: 0;
      opacity: 0.03;
      background-image: 
        radial-gradient(circle at 20% 30%, hsl(25, 15%, 20%) 1px, transparent 1px),
        radial-gradient(circle at 60% 70%, hsl(25, 15%, 20%) 1px, transparent 1px),
        radial-gradient(circle at 80% 20%, hsl(25, 15%, 20%) 1px, transparent 1px);
      background-size: 40px 40px, 60px 60px, 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 10;
      max-width: 42rem;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      animation: fadeInUp 0.7s ease-out;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .header .subtitle {
      font-size: 0.9rem;
      color: hsl(25, 10%, 45%);
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      background: white;
      padding: 0.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 20px -4px rgba(60, 45, 40, 0.08);
      animation: fadeInUp 0.7s ease-out 0.1s backwards;
    }

    .tab {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background: transparent;
      color: hsl(25, 15%, 40%);
    }

    .tab.active {
      background: linear-gradient(135deg, hsl(350, 75%, 58%), hsl(350, 75%, 48%));
      color: white;
      box-shadow: 0 4px 12px rgba(232, 53, 78, 0.3);
    }

    .leaderboard {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      animation: fadeInUp 0.7s ease-out 0.2s backwards;
    }

    .player-card {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 12px -2px rgba(60, 45, 40, 0.08);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .player-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px -2px rgba(60, 45, 40, 0.12);
    }

    .player-rank {
      font-size: 1.1rem;
      font-weight: bold;
      color: hsl(25, 10%, 45%);
      min-width: 40px;
      text-align: center;
    }

    .player-card.top-1 .player-rank {
      color: hsl(45, 90%, 50%);
      font-size: 1.3rem;
    }

    .player-card.top-2 .player-rank {
      color: hsl(0, 0%, 65%);
      font-size: 1.2rem;
    }

    .player-card.top-3 .player-rank {
      color: hsl(30, 80%, 55%);
      font-size: 1.2rem;
    }

    .player-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid hsl(35, 20%, 90%);
    }

    .player-card.top-1 .player-avatar {
      border-color: hsl(45, 90%, 50%);
    }

    .player-card.top-2 .player-avatar {
      border-color: hsl(0, 0%, 65%);
    }

    .player-card.top-3 .player-avatar {
      border-color: hsl(30, 80%, 55%);
    }

    .player-info {
      flex: 1;
    }

    .player-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .player-username {
      font-size: 0.85rem;
      color: hsl(350, 75%, 58%);
    }

    .player-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: hsl(350, 75%, 58%);
    }

    .my-rank-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, hsl(270, 100%, 65%), hsl(270, 100%, 55%));
      padding: 1rem;
      box-shadow: 0 -4px 20px rgba(120, 72, 255, 0.3);
      z-index: 100;
    }

    .my-rank-content {
      max-width: 42rem;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1rem;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .my-rank-label {
      font-size: 1.1rem;
      font-weight: bold;
      color: white;
      min-width: 60px;
      text-align: center;
    }

    .my-rank-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
    }

    .my-rank-info {
      flex: 1;
    }

    .my-rank-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: white;
      margin-bottom: 0.15rem;
    }

    .my-rank-username {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .my-rank-value {
      font-size: 1rem;
      font-weight: bold;
      color: white;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: hsl(25, 10%, 45%);
    }

    .hidden {
      display: none;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="rice-pattern"></div>
  
  <div class="container">
    <div class="header">
      <h1>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h1>
      <p class="subtitle">–¢–û–ü-100 –∏–≥—Ä–æ–∫–æ–≤ Orimori</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="coins">
        üí∞ Orimori Coin
      </button>
      <button class="tab" data-tab="xp">
        ‚≠ê Orimori XP
      </button>
    </div>

    <div id="loading" class="loading">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</p>
    </div>

    <div id="leaderboard" class="leaderboard hidden"></div>
  </div>

  <div class="my-rank-fixed">
    <div class="my-rank-content">
      <div class="my-rank-label" id="myRankPosition">#‚Äî</div>
      <img id="myRankAvatar" class="my-rank-avatar" src="" alt="My Avatar" />
      <div class="my-rank-info">
        <div class="my-rank-name" id="myRankName">‚Äî</div>
        <div class="my-rank-username" id="myRankUsername">‚Äî</div>
      </div>
      <div class="my-rank-value" id="myRankValue">‚Äî</div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://gierevxpvsajtjdwethi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZXJldnhwdnNhanRqZHdldGhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMTUzNzQsImV4cCI6MjA3ODg5MTM3NH0.LiVkWMW3MxPkGLhCYh5X8PrkBtWdYSn_nlgoUxrk-F8";

    // Initialize Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let currentTab = 'coins';
    let currentUser = null;
    let allPlayers = [];

    // Supabase API call
    async function supabaseRequest(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`Supabase error: ${response.status}`);
      }

      return response.json();
    }

    // Sync current user with Supabase
    async function syncCurrentUser() {
      try {
        const user = tg.initDataUnsafe.user;
        
        if (!user) {
          console.warn('Telegram user data not available');
          // Try to load from localStorage
          const cached = localStorage.getItem('orimori_user_data');
          if (cached) {
            currentUser = JSON.parse(cached);
            return currentUser;
          }
          throw new Error('Telegram user data not available');
        }

        const userPayload = {
          id: user.id,
          username: user.username || '',
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          photo_url: user.photo_url || '',
          auth_time: new Date().toISOString()
        };

        // Upsert user data
        await supabaseRequest(
          `users?id=eq.${user.id}`,
          'POST',
          userPayload
        );

        // Fetch full user data
        const fullData = await supabaseRequest(`users?id=eq.${user.id}&select=*`);
        
        if (fullData && fullData.length > 0) {
          currentUser = fullData[0];
          // Save to localStorage
          localStorage.setItem('orimori_user_data', JSON.stringify(currentUser));
        } else {
          console.warn('No user data returned from Supabase');
        }

        return currentUser;
      } catch (error) {
        console.error('User sync error:', error);
        // Try localStorage as fallback
        const cached = localStorage.getItem('orimori_user_data');
        if (cached) {
          currentUser = JSON.parse(cached);
        }
        return currentUser;
      }
    }

    // Fetch leaderboard data
    async function fetchLeaderboard(type = 'coins') {
      try {
        const orderBy = type === 'coins' ? 'orimori_coins' : 'orimori_xp';
        const players = await supabaseRequest(
          `users?select=*&order=${orderBy}.desc&limit=100`
        );
        
        return players || [];
      } catch (error) {
        console.error('Leaderboard fetch error:', error);
        return [];
      }
    }

    // Render leaderboard
    function renderLeaderboard(players, type) {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '';

      players.forEach((player, index) => {
        const rank = index + 1;
        const value = type === 'coins' ? player.orimori_coins : player.orimori_xp;
        const displayName = player.display_name || player.first_name || 'User';
        const username = player.username ? `@${player.username}` : `ID: ${player.id}`;
        const photoUrl = player.custom_photo || player.photo_url || 'https://via.placeholder.com/50';

        let topClass = '';
        if (rank === 1) topClass = 'top-1';
        else if (rank === 2) topClass = 'top-2';
        else if (rank === 3) topClass = 'top-3';

        const card = document.createElement('div');
        card.className = `player-card ${topClass}`;
        card.dataset.userId = player.id;
        card.innerHTML = `
          <div class="player-rank">#${rank}</div>
          <img class="player-avatar" src="${photoUrl}" alt="${displayName}" />
          <div class="player-info">
            <div class="player-name">${displayName}</div>
            <div class="player-username">${username}</div>
          </div>
          <div class="player-value">${value.toLocaleString()}</div>
        `;

        card.addEventListener('click', () => {
          window.location.href = `profile.html?id=${player.id}`;
        });

        leaderboard.appendChild(card);
      });
    }

    // Update "My Rank" section
    function updateMyRank(players, type) {
      if (!currentUser) {
        console.warn('Current user not available for rank display');
        document.getElementById('myRankPosition').textContent = '#‚Äî';
        document.getElementById('myRankName').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        document.getElementById('myRankUsername').textContent = '';
        document.getElementById('myRankValue').textContent = '‚Äî';
        return;
      }

      const myIndex = players.findIndex(p => p.id === currentUser.id);
      let myRank = myIndex >= 0 ? myIndex + 1 : null;
      
      // If not in top 100, calculate approximate rank
      if (myRank === null) {
        myRank = '100+';
      }
      
      const value = type === 'coins' ? (currentUser.orimori_coins || 0) : (currentUser.orimori_xp || 0);
      const displayName = currentUser.display_name || currentUser.first_name || 'User';
      const username = currentUser.username ? `@${currentUser.username}` : `ID: ${currentUser.id}`;
      const photoUrl = currentUser.custom_photo || currentUser.photo_url || 'https://via.placeholder.com/45';

      document.getElementById('myRankPosition').textContent = typeof myRank === 'number' ? `#${myRank}` : `#${myRank}`;
      document.getElementById('myRankAvatar').src = photoUrl;
      document.getElementById('myRankName').textContent = displayName;
      document.getElementById('myRankUsername').textContent = username;
      document.getElementById('myRankValue').textContent = typeof value === 'number' ? value.toLocaleString() : '0';
    }

    // Handle tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', async () => {
        const tabType = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update current tab
        currentTab = tabType;

        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('leaderboard').classList.add('hidden');

        // Fetch and render
        allPlayers = await fetchLeaderboard(tabType);
        renderLeaderboard(allPlayers, tabType);
        updateMyRank(allPlayers, tabType);

        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('leaderboard').classList.remove('hidden');
      });
    });

    // Initialize app
    async function init() {
      try {
        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('leaderboard').classList.add('hidden');

        // Sync current user first
        await syncCurrentUser();

        // Even if sync fails, continue loading leaderboard
        if (!currentUser) {
          console.warn('Failed to sync user, but continuing with leaderboard');
        }

        // Fetch initial leaderboard (coins)
        allPlayers = await fetchLeaderboard('coins');
        renderLeaderboard(allPlayers, 'coins');
        updateMyRank(allPlayers, 'coins');

        // Hide loading, show content
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('leaderboard').classList.remove('hidden');
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loading').innerHTML = '<p style="color: hsl(350, 75%, 58%);">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</p>';
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>
